name: Build and Test

# This workflow builds and tests the Avalonia desktop application
# built on .NET Core.
#
# To configure this workflow:
#
# 1. Configure environment variables
# Replace the variables relative to your project in the "env" section below.
#
# 2. Signing (Optional)
# If you want to sign your application, generate a signing certificate
# and add it as a GitHub secret named "Base64_Encoded_Pfx".
# Then uncomment the signing steps below.
#
# For more information on GitHub Actions, refer to https://github.com/features/actions
# For a complete CI/CD sample for Avalonia applications,
# refer to https://github.com/AvaloniaUI/Avalonia

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

env:
  PROJECT_NAME: TagAnalyzer
  PROJECT_PATH: TagAnalyzer.csproj
  DOTNET_VERSION: '10.0.x'

jobs:
  build:
    strategy:
      matrix:
        configuration: [Debug, Release]
    runs-on: windows-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    # Install the .NET Core SDK
    - name: Install .NET Core
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    # Restore dependencies
    - name: Restore dependencies
      run: dotnet restore ${{ env.PROJECT_PATH }}

    # Build the application
    - name: Build the application
      run: dotnet build ${{ env.PROJECT_PATH }} --configuration ${{ matrix.configuration }} --no-restore

    # Execute unit tests (if test project exists)
    - name: Execute unit tests
      run: dotnet test
      continue-on-error: true  # Continue if no test project exists

    # Publish the application as single-file executable (Windows)
    - name: Publish application (Windows x64)
      run: |
        dotnet publish ${{ env.PROJECT_PATH }} `
          --configuration ${{ matrix.configuration }} `
          --runtime win-x64 `
          --self-contained true `
          --output ./publish/win-x64-${{ matrix.configuration }} `
          --property:PublishSingleFile=true `
          --property:IncludeNativeLibrariesForSelfExtract=true `
          --property:EnableCompressionInSingleFile=true `
          --no-build

    # Optional: Code signing (uncomment and configure if needed)
    # - name: Decode the pfx
    #   run: |
    #     $pfx_cert_byte = [System.Convert]::FromBase64String("${{ secrets.Base64_Encoded_Pfx }}")
    #     $certificatePath = "GitHubActionsWorkflow.pfx"
    #     [IO.File]::WriteAllBytes("$certificatePath", $pfx_cert_byte)
    #   if: matrix.configuration == 'Release'

    # - name: Sign the executable
    #   run: |
    #     signtool sign /f GitHubActionsWorkflow.pfx /p "${{ secrets.Pfx_Key }}" /t http://timestamp.digicert.com /fd SHA256 ./publish/win-x64-${{ matrix.configuration }}/${{ env.PROJECT_NAME }}.exe
    #   if: matrix.configuration == 'Release'

    # - name: Remove the pfx
    #   run: Remove-Item -Path GitHubActionsWorkflow.pfx
    #   if: matrix.configuration == 'Release'

    # Upload build artifacts
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.PROJECT_NAME }}-${{ matrix.configuration }}-win-x64
        path: ./publish/win-x64-${{ matrix.configuration }}/**/*
        retention-days: 7

  build-linux:
    strategy:
      matrix:
        configuration: [Release]
        runtime: [linux-x64, linux-arm64]
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install .NET Core
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Restore dependencies
      run: dotnet restore ${{ env.PROJECT_PATH }}

    - name: Build the application
      run: dotnet build ${{ env.PROJECT_PATH }} --configuration ${{ matrix.configuration }} --no-restore

    - name: Publish application (Linux)
      run: |
        dotnet publish ${{ env.PROJECT_PATH }} \
          --configuration ${{ matrix.configuration }} \
          --runtime ${{ matrix.runtime }} \
          --self-contained true \
          --output ./publish/${{ matrix.runtime }}-${{ matrix.configuration }} \
          --property:PublishSingleFile=true \
          --property:IncludeNativeLibrariesForSelfExtract=true \
          --property:EnableCompressionInSingleFile=true \
          --no-build

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.PROJECT_NAME }}-${{ matrix.configuration }}-${{ matrix.runtime }}
        path: ./publish/${{ matrix.runtime }}-${{ matrix.configuration }}/**/*
        retention-days: 7

  build-macos:
    strategy:
      matrix:
        configuration: [Release]
        runtime: [osx-x64, osx-arm64]
    runs-on: macos-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install .NET Core
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Restore dependencies
      run: dotnet restore ${{ env.PROJECT_PATH }}

    - name: Build the application
      run: dotnet build ${{ env.PROJECT_PATH }} --configuration ${{ matrix.configuration }} --no-restore

    - name: Publish application (macOS)
      run: |
        dotnet publish ${{ env.PROJECT_PATH }} \
          --configuration ${{ matrix.configuration }} \
          --runtime ${{ matrix.runtime }} \
          --self-contained true \
          --output ./publish/${{ matrix.runtime }}-${{ matrix.configuration }} \
          --property:PublishSingleFile=true \
          --property:IncludeNativeLibrariesForSelfExtract=true \
          --property:EnableCompressionInSingleFile=true \
          --no-build

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.PROJECT_NAME }}-${{ matrix.configuration }}-${{ matrix.runtime }}
        path: ./publish/${{ matrix.runtime }}-${{ matrix.configuration }}/**/*
        retention-days: 7

  # è‡ªåŠ¨å‘å¸ƒåˆ° GitHub Releasesï¼ˆä»…é™æ¨é€åˆ° master åˆ†æ”¯æ—¶ï¼‰
  publish-release:
    needs: [build, build-linux, build-macos]
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    runs-on: windows-latest
    permissions:
      contents: write  # éœ€è¦å†™æƒé™æ¥åˆ›å»º Release

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: è·å–ç‰ˆæœ¬å·
      id: get_version
      run: |
        # ä»é¡¹ç›®æ–‡ä»¶ä¸­æå–ç‰ˆæœ¬å·
        $csprojContent = Get-Content ${{ env.PROJECT_PATH }} -Raw
        if ($csprojContent -match '<Version>([^<]+)</Version>') {
          $version = $matches[1]
        } elseif ($csprojContent -match '<AssemblyVersion>([^<]+)</AssemblyVersion>') {
          $version = $matches[1]
        } else {
          # ä½¿ç”¨æ—¥æœŸä½œä¸ºç‰ˆæœ¬å·
          $version = "dev-$(Get-Date -Format 'yyyyMMdd-HHmmss')"
        }
        echo "VERSION=$version" >> $env:GITHUB_OUTPUT
        echo "ç‰ˆæœ¬å·: $version"

    - name: ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
      uses: actions/download-artifact@v4
      with:
        path: ./artifacts

    - name: åˆ›å»ºå‘å¸ƒåŒ…
      run: |
        $version = "${{ steps.get_version.outputs.VERSION }}"
        $artifactsDir = "./artifacts"
        $packagesDir = "./packages"
        New-Item -ItemType Directory -Path $packagesDir -Force | Out-Null
        
        Write-Host "æ­£åœ¨åˆ›å»ºå‘å¸ƒåŒ…..." -ForegroundColor Green
        
        # Windows x64 Release
        $winArtifact = Get-ChildItem -Path $artifactsDir -Filter "*-Release-win-x64" -Directory | Select-Object -First 1
        if ($winArtifact) {
          $exePath = Join-Path $winArtifact.FullName "TagAnalyzer.exe"
          if (Test-Path $exePath) {
            $zipPath = "$packagesDir/TagAnalyzer-v$version-win-x64.zip"
            Compress-Archive -Path $exePath -DestinationPath $zipPath -Force
            Write-Host "å·²åˆ›å»º: $zipPath" -ForegroundColor Green
          }
        }
        
        # Linux x64
        $linuxX64Artifact = Get-ChildItem -Path $artifactsDir -Filter "*-Release-linux-x64" -Directory | Select-Object -First 1
        if ($linuxX64Artifact) {
          $exePath = Join-Path $linuxX64Artifact.FullName "TagAnalyzer"
          if (Test-Path $exePath) {
            $zipPath = "$packagesDir/TagAnalyzer-v$version-linux-x64.zip"
            Compress-Archive -Path $exePath -DestinationPath $zipPath -Force
            Write-Host "å·²åˆ›å»º: $zipPath" -ForegroundColor Green
          }
        }
        
        # Linux ARM64
        $linuxArm64Artifact = Get-ChildItem -Path $artifactsDir -Filter "*-Release-linux-arm64" -Directory | Select-Object -First 1
        if ($linuxArm64Artifact) {
          $exePath = Join-Path $linuxArm64Artifact.FullName "TagAnalyzer"
          if (Test-Path $exePath) {
            $zipPath = "$packagesDir/TagAnalyzer-v$version-linux-arm64.zip"
            Compress-Archive -Path $exePath -DestinationPath $zipPath -Force
            Write-Host "å·²åˆ›å»º: $zipPath" -ForegroundColor Green
          }
        }
        
        # macOS x64
        $osxX64Artifact = Get-ChildItem -Path $artifactsDir -Filter "*-Release-osx-x64" -Directory | Select-Object -First 1
        if ($osxX64Artifact) {
          $exePath = Join-Path $osxX64Artifact.FullName "TagAnalyzer"
          if (Test-Path $exePath) {
            $zipPath = "$packagesDir/TagAnalyzer-v$version-macos-x64.zip"
            Compress-Archive -Path $exePath -DestinationPath $zipPath -Force
            Write-Host "å·²åˆ›å»º: $zipPath" -ForegroundColor Green
          }
        }
        
        # macOS ARM64
        $osxArm64Artifact = Get-ChildItem -Path $artifactsDir -Filter "*-Release-osx-arm64" -Directory | Select-Object -First 1
        if ($osxArm64Artifact) {
          $exePath = Join-Path $osxArm64Artifact.FullName "TagAnalyzer"
          if (Test-Path $exePath) {
            $zipPath = "$packagesDir/TagAnalyzer-v$version-macos-arm64.zip"
            Compress-Archive -Path $exePath -DestinationPath $zipPath -Force
            Write-Host "å·²åˆ›å»º: $zipPath" -ForegroundColor Green
          }
        }
        
        Write-Host "æ‰€æœ‰å‘å¸ƒåŒ…å·²åˆ›å»ºå®Œæˆ" -ForegroundColor Green

    - name: åˆ›å»º GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag: auto-build-${{ steps.get_version.outputs.VERSION }}
        name: Auto Build v${{ steps.get_version.outputs.VERSION }}
        body: |
          ## ğŸš€ è‡ªåŠ¨æ„å»ºç‰ˆæœ¬ v${{ steps.get_version.outputs.VERSION }}
          
          > æ­¤ç‰ˆæœ¬ç”± GitHub Actions è‡ªåŠ¨æ„å»ºå¹¶å‘å¸ƒ
          > 
          > æ„å»ºæ—¶é—´: ${{ github.event.head_commit.timestamp || github.run_started_at }}
          > æäº¤: ${{ github.sha }}
          
          ### ğŸ“¦ ä¸‹è½½é“¾æ¥
          
          | å¹³å° | æ¶æ„ | ä¸‹è½½ |
          |------|------|------|
          | Windows | x64 | [TagAnalyzer-v${{ steps.get_version.outputs.VERSION }}-win-x64.zip](https://github.com/${{ github.repository }}/releases/download/auto-build-${{ steps.get_version.outputs.VERSION }}/TagAnalyzer-v${{ steps.get_version.outputs.VERSION }}-win-x64.zip) |
          | Linux | x64 | [TagAnalyzer-v${{ steps.get_version.outputs.VERSION }}-linux-x64.zip](https://github.com/${{ github.repository }}/releases/download/auto-build-${{ steps.get_version.outputs.VERSION }}/TagAnalyzer-v${{ steps.get_version.outputs.VERSION }}-linux-x64.zip) |
          | Linux | ARM64 | [TagAnalyzer-v${{ steps.get_version.outputs.VERSION }}-linux-arm64.zip](https://github.com/${{ github.repository }}/releases/download/auto-build-${{ steps.get_version.outputs.VERSION }}/TagAnalyzer-v${{ steps.get_version.outputs.VERSION }}-linux-arm64.zip) |
          | macOS | x64 | [TagAnalyzer-v${{ steps.get_version.outputs.VERSION }}-macos-x64.zip](https://github.com/${{ github.repository }}/releases/download/auto-build-${{ steps.get_version.outputs.VERSION }}/TagAnalyzer-v${{ steps.get_version.outputs.VERSION }}-macos-x64.zip) |
          | macOS | ARM64 | [TagAnalyzer-v${{ steps.get_version.outputs.VERSION }}-macos-arm64.zip](https://github.com/${{ github.repository }}/releases/download/auto-build-${{ steps.get_version.outputs.VERSION }}/TagAnalyzer-v${{ steps.get_version.outputs.VERSION }}-macos-arm64.zip) |
          
          ### ğŸš€ ä½¿ç”¨æ–¹æ³•
          
          1. ä¸‹è½½å¯¹åº”å¹³å°çš„ ZIP å‹ç¼©åŒ…
          2. è§£å‹æ–‡ä»¶
          3. è¿è¡Œå¯æ‰§è¡Œæ–‡ä»¶ï¼ˆWindows: `TagAnalyzer.exe`ï¼ŒLinux/macOS: `TagAnalyzer`ï¼‰
          
          ### âœ¨ ä¸»è¦åŠŸèƒ½
          
          - ğŸ¯ æ™ºèƒ½è§£ææ–‡æœ¬ä¸­çš„æ ‡ç­¾
          - ğŸ“Š ç»Ÿè®¡åˆ†ææ ‡ç­¾å‡ºç°æ¬¡æ•°
          - ğŸ“ æ”¯æŒå•æ–‡ä»¶å’Œæ‰¹é‡æ–‡ä»¶å¤¹å¤„ç†
          - ğŸ“„ CSV å¯¼å‡ºåŠŸèƒ½
          - ğŸ”¢ æ”¯æŒæ‰€æœ‰ M å¼€å¤´çš„æ•°å­—ç¼–å·æ ¼å¼ï¼ˆM24ã€M35ã€M1ã€M100 ç­‰ï¼‰
          - ğŸ“‹ ç‰ˆæœ¬ä¿¡æ¯æ˜¾ç¤ºï¼ˆå…³äºçª—å£ï¼‰
          
          ### ğŸ“‹ ç³»ç»Ÿè¦æ±‚
          
          - æ— éœ€å®‰è£… .NET Runtimeï¼ˆè‡ªåŒ…å«å‘å¸ƒï¼‰
          - Windows 10/11, Linux, æˆ– macOS
          
          ---
          
          **æ³¨æ„**: è¿™æ˜¯è‡ªåŠ¨æ„å»ºç‰ˆæœ¬ï¼Œå¦‚éœ€æ­£å¼å‘å¸ƒç‰ˆæœ¬ï¼Œè¯·ä½¿ç”¨ [release.yml](https://github.com/${{ github.repository }}/actions/workflows/release.yml) å·¥ä½œæµã€‚
          
          **ä½œè€…**: jiashuai_xu@qq.com
        files: ./packages/*.zip
        draft: false
        prerelease: true  # æ ‡è®°ä¸ºé¢„å‘å¸ƒç‰ˆæœ¬
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
