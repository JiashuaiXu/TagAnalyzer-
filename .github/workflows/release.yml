name: Build and Release

on:
  push:
    tags:
      - 'v*'  # å½“æ¨é€ä»¥ v å¼€å¤´çš„æ ‡ç­¾æ—¶è§¦å‘ï¼ˆå¦‚ v1.1.0ï¼‰
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      version:
        description: 'ç‰ˆæœ¬å· (ä¾‹å¦‚: 1.1.0)'
        required: true
        type: string

env:
  PROJECT_NAME: TagAnalyzer
  DOTNET_VERSION: '10.0.x'

jobs:
  build-and-release:
    runs-on: windows-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½® .NET SDK
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: è¿˜åŸä¾èµ–
      run: dotnet restore
      
    - name: æ„å»ºé¡¹ç›®
      run: dotnet build --configuration Release --no-restore
      
    - name: å‘å¸ƒä¸ºå•æ–‡ä»¶ï¼ˆWindows x64ï¼‰
      run: |
        dotnet publish --configuration Release `
          --runtime win-x64 `
          --self-contained true `
          --output ./publish/win-x64 `
          --property:PublishSingleFile=true `
          --property:IncludeNativeLibrariesForSelfExtract=true `
          --property:EnableCompressionInSingleFile=true `
          --no-build
      
    - name: è·å–ç‰ˆæœ¬å·
      id: get_version
      run: |
        if ("${{ github.event_name }}" -eq "workflow_dispatch") {
          $version = "${{ inputs.version }}"
        } else {
          $tag = "${{ github.ref_name }}"
          $version = $tag -replace '^v', ''
        }
        echo "VERSION=$version" >> $env:GITHUB_OUTPUT
        echo "ç‰ˆæœ¬å·: $version"
        
    - name: åˆ›å»ºå‘å¸ƒåŒ…åç§°
      id: package_name
      run: |
        $version = "${{ steps.get_version.outputs.VERSION }}"
        $packageName = "${{ env.PROJECT_NAME }}-v$version-win-x64.zip"
        echo "PACKAGE_NAME=$packageName" >> $env:GITHUB_OUTPUT
        echo "åŒ…åç§°: $packageName"
        
    - name: åˆ›å»ºå‘å¸ƒåŒ…
      run: |
        $packageName = "${{ steps.package_name.outputs.PACKAGE_NAME }}"
        $archivePath = "./artifacts/$packageName"
        New-Item -ItemType Directory -Path "./artifacts" -Force | Out-Null
        Compress-Archive -Path "./publish/win-x64/TagAnalyzer.exe" -DestinationPath $archivePath -Force
        echo "å‘å¸ƒåŒ…å·²åˆ›å»º: $archivePath"
        
    - name: ä¸Šä¼ å‘å¸ƒåŒ…
      uses: actions/upload-artifact@v4
      with:
        name: release-package
        path: artifacts/*.zip
        retention-days: 30
        
    - name: åˆ›å»º GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag: v${{ steps.get_version.outputs.VERSION }}
        files: artifacts/*.zip
        name: Release v${{ steps.get_version.outputs.VERSION }}
        body: |
          ## æ ‡ç­¾åˆ†æå·¥å…· v${{ steps.get_version.outputs.VERSION }}
          
          ### ğŸ“¦ å‘å¸ƒåŒ…
          - **Windows x64**: `${{ steps.package_name.outputs.PACKAGE_NAME }}`
          
          ### ğŸš€ ä½¿ç”¨æ–¹æ³•
          1. ä¸‹è½½å¹¶è§£å‹ `${{ steps.package_name.outputs.PACKAGE_NAME }}`
          2. åŒå‡» `TagAnalyzer.exe` è¿è¡Œç¨‹åº
          3. ç‚¹å‡»"é€‰æ‹©æ–‡ä»¶"æŒ‰é’®é€‰æ‹© .txt æ–‡ä»¶è¿›è¡Œåˆ†æ
          4. ç‚¹å‡»"å¯¼å‡ºCSV"ä¿å­˜ç»“æœ
          
          ### âœ¨ ä¸»è¦åŠŸèƒ½
          - ğŸ¯ æ™ºèƒ½è§£ææ–‡æœ¬ä¸­çš„æ ‡ç­¾
          - ğŸ“Š ç»Ÿè®¡åˆ†ææ ‡ç­¾å‡ºç°æ¬¡æ•°
          - ğŸ“ æ”¯æŒå•æ–‡ä»¶å’Œæ‰¹é‡æ–‡ä»¶å¤¹å¤„ç†
          - ğŸ“„ CSV å¯¼å‡ºåŠŸèƒ½
          - ğŸ”¢ æ”¯æŒæ‰€æœ‰ M å¼€å¤´çš„æ•°å­—ç¼–å·æ ¼å¼ï¼ˆM24ã€M35ã€M1ã€M100 ç­‰ï¼‰
          - ğŸ“‹ ç‰ˆæœ¬ä¿¡æ¯æ˜¾ç¤ºï¼ˆå…³äºçª—å£ï¼‰
          
          ### ğŸ“‹ ç³»ç»Ÿè¦æ±‚
          - Windows 10/11
          - æ— éœ€å®‰è£… .NET Runtimeï¼ˆè‡ªåŒ…å«å‘å¸ƒï¼‰
          
          ### ğŸ“ æ›´æ–°æ—¥å¿—
          æŸ¥çœ‹ [README.md](https://github.com/${{ github.repository }}/blob/master/README.md#æ›´æ–°æ—¥å¿—) äº†è§£è¯¦ç»†æ›´æ–°å†…å®¹ã€‚
          
          ---
          **ä½œè€…**: jiashuai_xu@qq.com
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

